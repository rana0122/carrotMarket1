<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
  <title>상품 수정</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    .carousel {
      position: relative;
    }
    .carousel-inner {
      border-radius: 4px;
      overflow: hidden;
    }
    .carousel-item {
      display: none;
    }
    .carousel-item.active {
      display: block;
    }
    .carousel-item img {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }
    .btn-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    .carousel-nav {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
    }
    .carousel-nav button {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #ddd;
      border: none;
      cursor: pointer;
    }
    .carousel-nav button.active {
      background: #666;
    }

    /* 수정된 부분: 이미지 미리보기 영역 스타일 */
    .image-preview {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .image-item {
      display: inline-block;
      position: relative;
    }

    .image-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
    }

    .delete-checkbox {
      text-align: center;
      margin-top: 5px;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div class="write-container">
    <h1 class="mb-4">상품 수정</h1>
    <form th:action="@{/products/update/{id}(id=${product.id})}"
          method="post" enctype="multipart/form-data">

      <div class="content-wrapper">
        <div class="content-wrapper">
          <div class="image-section">
            <!-- 기존 이미지 표시 영역 -->
            <div class="image-preview" th:if="${!#lists.isEmpty(product.images)}">
              <div class="carousel">
                <div th:each="image : ${product.images}" class="image-item">
                  <img th:src="${image.imageUrl}" style="width: 100px; height: 100px;" />
                  <div class="delete-checkbox">
                    <input type="checkbox" name="deleteImageIds" th:value="${image.id}" /> 삭제
                  </div>
                </div>
              </div>
            </div>

            <!-- 새 이미지 업로드 영역 -->
            <div class="image-upload">
              <p>이미지를 업로드해주세요</p>
              <input type="file" name="productImages" multiple accept="image/*" />
            </div>
          </div>

        <div class="form-section">

          <div class="form-group">

            <label class="form-label">카테고리</label>
            <select id="category" name="categoryId" class="form-control" required>
              <option value="" disabled>카테고리를 선택하세요</option>
              <option th:each="category : ${category}"
                      th:value="${category.id}"
                      th:text="${category.name}"
                      th:selected="${product.categoryId == category.id}"></option>
            </select><br>
          </div>

          <div class="form-group">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" name="title" th:field="*{product.title}" th:value="${product.title}" required>
          </div>

          <div class="form-group">
            <label class="form-label">설명</label>
            <textarea class="form-control" name="description" rows="5" th:field="*{product.description}" required th:text="${product.description}"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">가격</label>
            <input type="number" class="form-control" name="price" th:field="*{product.price}" th:value="${product.price}" required>
          </div>

          <button type="submit" class="submit-btn">등록하기</button>

        </div>
      </div>
    </form>
  </div>
</div>

<th:block layout:fragment="pageScript">
  <script>
    function showSlide(index) {
      const items = document.querySelectorAll('.carousel-item');
      const navButtons = document.querySelectorAll('.carousel-nav button');

      items.forEach(item => item.classList.remove('active'));
      navButtons.forEach(btn => btn.classList.remove('active'));

      items[index].classList.add('active');
      navButtons[index].classList.add('active');
    }

    function deleteImage(imageId) {
      if (!confirm('이미지를 삭제하시겠습니까?')) return;

      fetch(`/api/images/${imageId}`, {
        method: 'DELETE'
      }).then(response => {
        if (response.ok) location.reload();
      });
    }

    document.getElementById('imageInput').addEventListener('change', function(e) {
      if (!e.target.files.length) return;

      const formData = new FormData();
      for (let file of e.target.files) {
        formData.append('images', file);
      }

      fetch(`/api/products/${productId}/images`, {
        method: 'POST',
        body: formData
      }).then(response => response.json())
              .then(() => location.reload());
    });
  </script>
</th:block>
</body>
</html>

