<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="miniproject.carrotmarket1.dao.MySQL.ReportDAO">

    <!-- 동적 쿼리: 통계 데이터 조회 -->
    <select id="getReportStats" resultType="map">
        SELECT
        <choose>
            <when test="period == 'daily'">
                DATE(r.created_at) AS reportDate,
            </when>
            <when test="period == 'weekly'">
                YEAR(r.created_at) AS year,
                WEEK(r.created_at) AS week,
            </when>
            <when test="period == 'monthly'">
                YEAR(r.created_at) AS year,
                MONTH(r.created_at) AS month,
            </when>
            <otherwise>
                DATE(r.created_at) AS reportDate,
            </otherwise>
        </choose>
        c.name AS category,
        COUNT(*) AS total
        FROM report r
        JOIN category c ON r.category_id = c.id
        WHERE r.created_at >=
        <choose>
            <when test="period == 'daily'">
                CURDATE() - INTERVAL 7 DAY
            </when>
            <when test="period == 'weekly'">
                CURDATE() - INTERVAL 1 MONTH
            </when>
            <when test="period == 'monthly'">
                CURDATE() - INTERVAL 1 YEAR
            </when>
            <otherwise>
                CURDATE() - INTERVAL 7 DAY
            </otherwise>
        </choose>
        GROUP BY
        <choose>
            <when test="period == 'daily'">
                DATE(r.created_at), c.name
            </when>
            <when test="period == 'weekly'">
                YEAR(r.created_at), WEEK(r.created_at), c.name
            </when>
            <when test="period == 'monthly'">
                YEAR(r.created_at), MONTH(r.created_at), c.name
            </when>
            <otherwise>
                DATE(r.created_at), c.name
            </otherwise>
        </choose>
        ORDER BY
        <choose>
            <when test="period == 'daily'">
                DATE(r.created_at), c.name
            </when>
            <when test="period == 'weekly'">
                YEAR(r.created_at), WEEK(r.created_at), c.name
            </when>
            <when test="period == 'monthly'">
                YEAR(r.created_at), MONTH(r.created_at), c.name
            </when>
            <otherwise>
                DATE(r.created_at), c.name
            </otherwise>
        </choose>
    </select>

    <!-- ResultMap 정의 -->
    <resultMap id="ReportResultMap" type="Report">
        <id property="id" column="id"/>
        <result property="createdAt" column="created_at"/>
        <result property="status" column="status"/>

        <association property="reporter" column="reporter_id" javaType="User"
                     select="miniproject.carrotmarket1.dao.MySQL.UserDAO.selectById"/>
        <association property="category" column="category_id" javaType="Category"
                     select="miniproject.carrotmarket1.dao.MySQL.CategoryDAO.selectById"/>
        <association property="product" column="product_id" javaType="Product"
                     select="miniproject.carrotmarket1.dao.MySQL.ProductDAO.findById"/>
    </resultMap>

    <select id="findFilteredReportsWithPagination" resultMap="ReportResultMap">
        SELECT * FROM report
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND created_at &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND created_at &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY created_at DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 전체 필터된 데이터 개수를 반환하는 쿼리 -->
    <select id="countFilteredReports" resultType="long">
        SELECT COUNT(*) FROM report
        WHERE 1=1
        <if test="startDate != null and startDate != ''">
            AND created_at &gt;= #{startDate}
        </if>
        <if test="endDate != null and endDate != ''">
            AND created_at &lt;= #{endDate}
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
    </select>

</mapper>
